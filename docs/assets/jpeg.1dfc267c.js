import{B as e}from"./basedecoder.7751ec97.js";const n=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]);function t(e,n){let t=0;const r=[];let s=16;for(;s>0&&!e[s-1];)--s;r.push({children:[],index:0});let o,a=r[0];for(let c=0;c<s;c++){for(let s=0;s<e[c];s++){for(a=r.pop(),a.children[a.index]=n[t];a.index>0;)a=r.pop();for(a.index++,r.push(a);r.length<=c;)r.push(o={children:[],index:0}),a.children[a.index]=o.children,a=o;t++}c+1<s&&(r.push(o={children:[],index:0}),a.children[a.index]=o.children,a=o)}return r[0].children}function r(e,t,r,s,o,a,c,i,l){const{mcusPerLine:f,progressive:h}=r,u=t;let m=t,b=0,d=0;function p(){if(d>0)return d--,b>>d&1;if(b=e[m++],255===b){const n=e[m++];if(n)throw new Error(`unexpected marker: ${(b<<8|n).toString(16)}`)}return d=7,b>>>7}function w(e){let n,t=e;for(;null!==(n=p());){if(t=t[n],"number"==typeof t)return t;if("object"!=typeof t)throw new Error("invalid huffman sequence")}return null}function k(e){let n=e,t=0;for(;n>0;){const e=p();if(null===e)return;t=t<<1|e,--n}return t}function y(e){const n=k(e);return n>=1<<e-1?n:n+(-1<<e)+1}let P=0;let T,x=0;function C(e,n,t,r,s){const o=t%f,a=(t/f|0)*e.v+r,c=o*e.h+s;n(e,e.blocks[a][c])}function g(e,n,t){const r=t/e.blocksPerLine|0,s=t%e.blocksPerLine;n(e,e.blocks[r][s])}const v=s.length;let A,L,E,D,I,q;q=h?0===a?0===i?function(e,n){const t=w(e.huffmanTableDC),r=0===t?0:y(t)<<l;e.pred+=r,n[0]=e.pred}:function(e,n){n[0]|=p()<<l}:0===i?function(e,t){if(P>0)return void P--;let r=a;const s=c;for(;r<=s;){const s=w(e.huffmanTableAC),o=15&s,a=s>>4;if(0===o){if(a<15){P=k(a)+(1<<a)-1;break}r+=16}else r+=a,t[n[r]]=y(o)*(1<<l),r++}}:function(e,t){let r=a;const s=c;let o=0;for(;r<=s;){const s=n[r],a=t[s]<0?-1:1;switch(x){case 0:{const n=w(e.huffmanTableAC),t=15&n;if(o=n>>4,0===t)o<15?(P=k(o)+(1<<o),x=4):(o=16,x=1);else{if(1!==t)throw new Error("invalid ACn encoding");T=y(t),x=o?2:3}continue}case 1:case 2:t[s]?t[s]+=(p()<<l)*a:(o--,0===o&&(x=2===x?3:0));break;case 3:t[s]?t[s]+=(p()<<l)*a:(t[s]=T<<l,x=0);break;case 4:t[s]&&(t[s]+=(p()<<l)*a)}r++}4===x&&(P--,0===P&&(x=0))}:function(e,t){const r=w(e.huffmanTableDC),s=0===r?0:y(r);e.pred+=s,t[0]=e.pred;let o=1;for(;o<64;){const r=w(e.huffmanTableAC),s=15&r,a=r>>4;if(0===s){if(a<15)break;o+=16}else o+=a,t[n[o]]=y(s),o++}};let z,O,U=0;O=1===v?s[0].blocksPerLine*s[0].blocksPerColumn:f*r.mcusPerColumn;const j=o||O;for(;U<O;){for(L=0;L<v;L++)s[L].pred=0;if(P=0,1===v)for(A=s[0],I=0;I<j;I++)g(A,q,U),U++;else for(I=0;I<j;I++){for(L=0;L<v;L++){A=s[L];const{h:e,v:n}=A;for(E=0;E<n;E++)for(D=0;D<e;D++)C(A,q,U,E,D)}if(U++,U===O)break}if(d=0,z=e[m]<<8|e[m+1],z<65280)throw new Error("marker was not found");if(!(z>=65488&&z<=65495))break;m+=2}return m-u}function s(e,n){const t=[],{blocksPerLine:r,blocksPerColumn:s}=n,o=r<<3,a=new Int32Array(64),c=new Uint8Array(64);function i(e,t,r){const s=n.quantizationTable;let o,a,c,i,l,f,h,u,m;const b=r;let d;for(d=0;d<64;d++)b[d]=e[d]*s[d];for(d=0;d<8;++d){const e=8*d;0!==b[1+e]||0!==b[2+e]||0!==b[3+e]||0!==b[4+e]||0!==b[5+e]||0!==b[6+e]||0!==b[7+e]?(o=5793*b[0+e]+128>>8,a=5793*b[4+e]+128>>8,c=b[2+e],i=b[6+e],l=2896*(b[1+e]-b[7+e])+128>>8,u=2896*(b[1+e]+b[7+e])+128>>8,f=b[3+e]<<4,h=b[5+e]<<4,m=o-a+1>>1,o=o+a+1>>1,a=m,m=3784*c+1567*i+128>>8,c=1567*c-3784*i+128>>8,i=m,m=l-h+1>>1,l=l+h+1>>1,h=m,m=u+f+1>>1,f=u-f+1>>1,u=m,m=o-i+1>>1,o=o+i+1>>1,i=m,m=a-c+1>>1,a=a+c+1>>1,c=m,m=2276*l+3406*u+2048>>12,l=3406*l-2276*u+2048>>12,u=m,m=799*f+4017*h+2048>>12,f=4017*f-799*h+2048>>12,h=m,b[0+e]=o+u,b[7+e]=o-u,b[1+e]=a+h,b[6+e]=a-h,b[2+e]=c+f,b[5+e]=c-f,b[3+e]=i+l,b[4+e]=i-l):(m=5793*b[0+e]+512>>10,b[0+e]=m,b[1+e]=m,b[2+e]=m,b[3+e]=m,b[4+e]=m,b[5+e]=m,b[6+e]=m,b[7+e]=m)}for(d=0;d<8;++d){const e=d;0!==b[8+e]||0!==b[16+e]||0!==b[24+e]||0!==b[32+e]||0!==b[40+e]||0!==b[48+e]||0!==b[56+e]?(o=5793*b[0+e]+2048>>12,a=5793*b[32+e]+2048>>12,c=b[16+e],i=b[48+e],l=2896*(b[8+e]-b[56+e])+2048>>12,u=2896*(b[8+e]+b[56+e])+2048>>12,f=b[24+e],h=b[40+e],m=o-a+1>>1,o=o+a+1>>1,a=m,m=3784*c+1567*i+2048>>12,c=1567*c-3784*i+2048>>12,i=m,m=l-h+1>>1,l=l+h+1>>1,h=m,m=u+f+1>>1,f=u-f+1>>1,u=m,m=o-i+1>>1,o=o+i+1>>1,i=m,m=a-c+1>>1,a=a+c+1>>1,c=m,m=2276*l+3406*u+2048>>12,l=3406*l-2276*u+2048>>12,u=m,m=799*f+4017*h+2048>>12,f=4017*f-799*h+2048>>12,h=m,b[0+e]=o+u,b[56+e]=o-u,b[8+e]=a+h,b[48+e]=a-h,b[16+e]=c+f,b[40+e]=c-f,b[24+e]=i+l,b[32+e]=i-l):(m=5793*r[d+0]+8192>>14,b[0+e]=m,b[8+e]=m,b[16+e]=m,b[24+e]=m,b[32+e]=m,b[40+e]=m,b[48+e]=m,b[56+e]=m)}for(d=0;d<64;++d){const e=128+(b[d]+8>>4);t[d]=e<0?0:e>255?255:e}}for(let l=0;l<s;l++){const e=l<<3;for(let n=0;n<8;n++)t.push(new Uint8Array(o));for(let s=0;s<r;s++){i(n.blocks[l][s],c,a);let r=0;const o=s<<3;for(let n=0;n<8;n++){const s=t[e+n];for(let e=0;e<8;e++)s[o+e]=c[r++]}}}return t}class o{constructor(){this.jfif=null,this.adobe=null,this.quantizationTables=[],this.huffmanTablesAC=[],this.huffmanTablesDC=[],this.resetFrames()}resetFrames(){this.frames=[]}parse(e){let s=0;function o(){const n=e[s]<<8|e[s+1];return s+=2,n}function a(){const n=o(),t=e.subarray(s,s+n-2);return s+=t.length,t}function c(e){let n,t,r=0,s=0;for(t in e.components)e.components.hasOwnProperty(t)&&(n=e.components[t],r<n.h&&(r=n.h),s<n.v&&(s=n.v));const o=Math.ceil(e.samplesPerLine/8/r),a=Math.ceil(e.scanLines/8/s);for(t in e.components)if(e.components.hasOwnProperty(t)){n=e.components[t];const c=Math.ceil(Math.ceil(e.samplesPerLine/8)*n.h/r),i=Math.ceil(Math.ceil(e.scanLines/8)*n.v/s),l=o*n.h,f=a*n.v,h=[];for(let e=0;e<f;e++){const e=[];for(let n=0;n<l;n++)e.push(new Int32Array(64));h.push(e)}n.blocksPerLine=c,n.blocksPerColumn=i,n.blocks=h}e.maxH=r,e.maxV=s,e.mcusPerLine=o,e.mcusPerColumn=a}let i=o();if(65496!==i)throw new Error("SOI not found");for(i=o();65497!==i;){switch(i){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:{const e=a();65504===i&&74===e[0]&&70===e[1]&&73===e[2]&&70===e[3]&&0===e[4]&&(this.jfif={version:{major:e[5],minor:e[6]},densityUnits:e[7],xDensity:e[8]<<8|e[9],yDensity:e[10]<<8|e[11],thumbWidth:e[12],thumbHeight:e[13],thumbData:e.subarray(14,14+3*e[12]*e[13])}),65518===i&&65===e[0]&&100===e[1]&&111===e[2]&&98===e[3]&&101===e[4]&&0===e[5]&&(this.adobe={version:e[6],flags0:e[7]<<8|e[8],flags1:e[9]<<8|e[10],transformCode:e[11]});break}case 65499:{const t=o()+s-2;for(;s<t;){const t=e[s++],r=new Int32Array(64);if(t>>4==0)for(let o=0;o<64;o++){r[n[o]]=e[s++]}else{if(t>>4!=1)throw new Error("DQT: invalid table spec");for(let e=0;e<64;e++){r[n[e]]=o()}}this.quantizationTables[15&t]=r}break}case 65472:case 65473:case 65474:{o();const n={extended:65473===i,progressive:65474===i,precision:e[s++],scanLines:o(),samplesPerLine:o(),components:{},componentsOrder:[]},t=e[s++];let r;for(let o=0;o<t;o++){r=e[s];const t=e[s+1]>>4,o=15&e[s+1],a=e[s+2];n.componentsOrder.push(r),n.components[r]={h:t,v:o,quantizationIdx:a},s+=3}c(n),this.frames.push(n);break}case 65476:{const n=o();for(let r=2;r<n;){const n=e[s++],o=new Uint8Array(16);let a=0;for(let t=0;t<16;t++,s++)o[t]=e[s],a+=o[t];const c=new Uint8Array(a);for(let t=0;t<a;t++,s++)c[t]=e[s];r+=17+a,n>>4==0?this.huffmanTablesDC[15&n]=t(o,c):this.huffmanTablesAC[15&n]=t(o,c)}break}case 65501:o(),this.resetInterval=o();break;case 65498:{o();const n=e[s++],t=[],a=this.frames[0];for(let r=0;r<n;r++){const n=a.components[e[s++]],r=e[s++];n.huffmanTableDC=this.huffmanTablesDC[r>>4],n.huffmanTableAC=this.huffmanTablesAC[15&r],t.push(n)}const c=e[s++],i=e[s++],l=e[s++],f=r(e,s,a,t,this.resetInterval,c,i,l>>4,15&l);s+=f;break}case 65535:255!==e[s]&&s--;break;default:if(255===e[s-3]&&e[s-2]>=192&&e[s-2]<=254){s-=3;break}throw new Error(`unknown JPEG marker ${i.toString(16)}`)}i=o()}}getResult(){const{frames:e}=this;if(0===this.frames.length)throw new Error("no frames were decoded");this.frames.length>1&&console.warn("more than one frame is not supported");for(let s=0;s<this.frames.length;s++){const e=this.frames[s].components;for(const n of Object.keys(e))e[n].quantizationTable=this.quantizationTables[e[n].quantizationIdx],delete e[n].quantizationIdx}const n=e[0],{components:t,componentsOrder:r}=n,o=[],a=n.samplesPerLine,c=n.scanLines;for(let f=0;f<r.length;f++){const e=t[r[f]];o.push({lines:s(0,e),scaleX:e.h/n.maxH,scaleY:e.v/n.maxV})}const i=new Uint8Array(a*c*o.length);let l=0;for(let s=0;s<c;++s)for(let e=0;e<a;++e)for(let n=0;n<o.length;++n){const t=o[n];i[l]=t.lines[0|s*t.scaleY][0|e*t.scaleX],++l}return i}}class a extends e{constructor(e){super(),this.reader=new o,e.JPEGTables&&this.reader.parse(e.JPEGTables)}decodeBlock(e){return this.reader.resetFrames(),this.reader.parse(new Uint8Array(e)),this.reader.getResult().buffer}}export{a as default};
